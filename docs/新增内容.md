# 新增内容

## 4.17

### 常见的Mysql集群模式

+ 主从服务器
+ 分片中间件：MayCat+shardingJDBC
  + 适合10亿级别的数量总集的大型应用，
  + 如果超过这个数据量采用大数据解决方案更好
+ MHA高可用

### 红包雨架构设计

**描述：**

1亿红包，3000万人强，红包数量1000万个，TPS预计百万，如何设计

**尝试沟通问题：**

1. 每个红包额度大小是否相等？
2. 每个用户的红包数量是否有限制？

**关注点**

1. **高性能**：保证用户体验
2. **高可靠**：不能超发
3. 高可用

**设备情况**

+ 负载均衡选择
  + Nginx 万级别（不满足），一般能到5万/s
  + LVS 十万级别 80w/s
  + 商业服务器F5，百万级别，可以达到200万/s~800万/s
+ 如果不想用负载均衡方案，可以使用固定机房+DNS的方式，每个机房固定多少红包，每个地区的用户访问自己的地区机房，然后抢红包之后，通过MQ同步到用户的账户中
+ 按照20个机房计算，每机房也要有50万TPS左右的访问量，这个时候可以使用Redis，按照每个8万计算，可以部署8个服务，然后每个Redis实例存储一个拆分好的红包的 id+红包金额的List，抢红包的时候用Lua脚本从List中 pop 一个元素同时记录到另一个List中，记录用户uid+红包ID+红包金额，然后定时任务集群不断从Redis集群中消费这些数据，批量插入MySql数据库，同时使用MQ通知用户账户入账
  + 可以提前生成每一个红包的金额，不进行实施计算
  + 动态限流，减少无效请求
  + 内存队列，避免争抢
  + 转账异步化
+ 同时我们可以使用uid对Mysql进行分库分表
+ 注意点：中间件的高可用、无状态服务的弹性伸缩、压测和限流

